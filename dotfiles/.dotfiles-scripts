#!/bin/bash

print_banner() {
  echo -e "
██████╗  ██████╗ ████████╗███████╗██╗██╗     ███████╗███████╗
██╔══██╗██╔═══██╗╚══██╔══╝██╔════╝██║██║     ██╔════╝██╔════╝
██║  ██║██║   ██║   ██║   █████╗  ██║██║     █████╗  ███████╗
██║  ██║██║   ██║   ██║   ██╔══╝  ██║██║     ██╔══╝  ╚════██║
██████╔╝╚██████╔╝   ██║   ██║     ██║███████╗███████╗███████║
╚═════╝  ╚═════╝    ╚═╝   ╚═╝     ╚═╝╚══════╝╚══════╝╚══════╝ (shell: ${SHELL})
"
}

print_error() {
  echo "Usage: .dotfiles-scripts --install / .dotfiles-scripts --uninstall"
  exit 1
}

install_dotfiles() {
  echo -e "\n--------------------- Installing .dotfiles ---------------------"
  local output=""
  local DOT_FILES_TO_INSTALL=$(find $(PWD)/dotfiles/files -name ".*" -not -name ".gitignore" -not -name ".travis.yml" -not -name ".git" -not -name ".*.swp" -not -name ".gnupg" -not -name ".idea")
  for file in ${DOT_FILES_TO_INSTALL}; do
    f=$(basename ${file})
    # Install .zsh files only for zsh shell and vice versa for .bash files and bash shell
    if [[ ${f} == *".zsh"* && $(echo ${SHELL}) != *"zsh"* ]]; then
      continue
    elif [[ ${f} == *".bash"* && $(echo ${SHELL}) != *"bash"* ]]; then
      continue
    else
      ln -sfn ${file} ${HOME}/${f}
    fi

    output+="\n  ${f} --> ${file}"
  done;

  echo -e "\nSuccessfully installed the following .dotfiles:\n" ${output}
  echo -e "\n    Done.\n"
}

uninstall_dotfiles() {
  echo -e "\n--------------------- Uninstalling .dotfiles ---------------------"
  local output=""
  local DOT_FILES_TO_UNINSTALL=$(find $(PWD)/dotfiles/files -name ".*" -not -name ".gitignore" -not -name ".travis.yml" -not -name ".git" -not -name ".*.swp" -not -name ".gnupg" -not -name ".idea")
  for file in ${DOT_FILES_TO_UNINSTALL}; do
    f=$(basename ${file})
    # Uninstall .zsh files only for zsh shell and vice versa for .bash files and bash shell
    if [[ ${f} == *".zsh"* && $(echo ${SHELL}) != *"zsh"* ]]; then
      continue
    elif [[ ${f} == *".bash"* && $(echo ${SHELL}) != *"bash"* ]]; then
      continue
    else
      unlink ${HOME}/${f}
    fi

    output+="\n  ${f}"
  done;

  echo -e "\nSuccessfully uninstalled the following .dotfiles:\n" ${output}
  echo -e "\n    Done.\n"
}

verify_pre_install() {
  read -p "Do you want to install dotfiles symlinks for [${SHELL}]? (y/n): " input
  if [[ ${input} != "y" ]]; then
    echo -e "\n    Nothing has changed.\n"
    exit 0
  fi
}

verify_pre_uninstall() {
  read -p "Do you want to uninstall all dotfiles symlinks? (y/n): " input
  if [[ ${input} != "y" ]]; then
    echo -e "\n    Nothing has changed.\n"
    exit 0
  fi
}

main() {
  if [[ $# -eq 0 ]]; then
    print_error
  fi

  action=$1

  if [[ ${action} = "--install" ]]; then
    print_banner
    verify_pre_install
    install_dotfiles
  elif [[ ${action} = "--uninstall" ]]; then
    verify_pre_uninstall
    uninstall_dotfiles
  else
    print_error
  fi
}

main "$@"